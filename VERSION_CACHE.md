# 版本显示与缓存处理

## ✨ 功能说明

为了防止前端缓存导致用户使用旧版本，系统实现了以下功能：

1. **版本信息显示** - 在首页右下角隐蔽位置显示版本号和构建时间
2. **自动更新检测** - 自动检测是否有新版本可用
3. **缓存清除机制** - 提供一键清除缓存并刷新的功能
4. **Service Worker 更新** - 自动处理 Service Worker 的更新

## 📍 版本信息显示位置

版本信息显示在**首页右下角**，非常隐蔽：
- 默认显示为半透明的小字：`v0.1.0 (12/25 14:30)`
- 鼠标悬停时稍微变亮
- 有新版本时会显示橙色圆点并闪烁提示

## 🔍 如何查看版本信息

1. **查看版本号**：直接看右下角的小字即可
2. **查看详细信息**：点击右下角的版本号，会弹出详细信息卡片，包括：
   - 版本号
   - 构建时间
   - 是否有新版本可用
   - 清除缓存并刷新按钮

## 🔄 自动更新检测

系统会自动检测新版本：

1. **Service Worker 更新检测**
   - 每小时自动检查一次
   - 检测到新版本时会触发更新事件

2. **视觉提示**
   - 有新版本时，版本号旁边会显示橙色圆点
   - 版本号会闪烁提示
   - 点击查看详情时会显示警告信息

3. **更新通知**
   - 检测到新版本时会显示提示消息

## 🧹 清除缓存

如果发现使用的是旧版本，可以：

1. **点击版本号**打开详情卡片
2. **点击"清除缓存并刷新"按钮**
3. 系统会：
   - 注销所有 Service Worker
   - 清除所有缓存
   - 自动刷新页面

## 🛠️ 技术实现

### 版本信息注入

版本信息在构建时自动注入：

- **版本号**：从 `package.json` 读取
- **构建时间**：构建时的时间戳
- 通过 `vite.config.ts` 的 `define` 配置注入到代码中

### Service Worker 更新

- Service Worker 缓存名称包含版本号（`feynman-trainer-v2`）
- 每次更新时修改缓存名称，强制更新缓存
- 自动检测并激活新版本

### 缓存策略

- **静态资源**：使用版本号或哈希值，确保更新后立即获取新资源
- **HTML 文件**：通过 Service Worker 控制缓存
- **API 请求**：不缓存，始终获取最新数据

## 📝 更新版本号

当需要发布新版本时：

1. **更新 package.json 中的版本号**：
   ```json
   {
     "version": "0.1.1"  // 更新版本号
   }
   ```

2. **更新 Service Worker 缓存名称**（`public/sw.js`）：
   ```javascript
   const CACHE_NAME = 'feynman-trainer-v3'  // 更新版本号
   ```

3. **重新构建和部署**：
   ```bash
   npm run build
   ```

## ⚠️ 注意事项

1. **版本号格式**：建议使用语义化版本（如 `0.1.0`、`0.1.1`、`1.0.0`）
2. **缓存清理**：更新 Service Worker 缓存名称后，旧缓存会被自动清理
3. **用户提示**：有新版本时，系统会自动提示用户，但不会强制刷新（避免打断用户操作）

## 🎯 最佳实践

1. **每次发布新版本时**：
   - 更新 `package.json` 中的版本号
   - 更新 Service Worker 缓存名称
   - 重新构建和部署

2. **重大更新时**：
   - 可以考虑增加主版本号（如 `0.1.0` → `0.2.0`）
   - 在更新日志中说明更新内容

3. **测试版本显示**：
   - 部署后检查右下角版本号是否正确
   - 测试清除缓存功能是否正常工作

## 🔧 故障排查

### 问题：版本号显示不正确

**解决方案**：
- 检查 `vite.config.ts` 中的版本注入配置
- 确认 `package.json` 中的版本号已更新
- 重新构建项目

### 问题：缓存没有清除

**解决方案**：
- 手动清除浏览器缓存
- 在浏览器开发者工具中清除 Service Worker
- 使用"清除缓存并刷新"功能

### 问题：检测不到新版本

**解决方案**：
- 检查 Service Worker 是否正常注册
- 确认 Service Worker 缓存名称已更新
- 等待自动检测（最多5分钟）或手动刷新页面

